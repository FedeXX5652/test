<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Converter</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { box-sizing: border-box; }
        
        :root {
            --primary: #4F46E5;
            --primary-light: #6366F1;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg-primary: #0F172A;
            --bg-secondary: #1E293B;
            --bg-tertiary: #334155;
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --text-muted: #64748B;
            --border: #334155;
            --border-hover: #475569;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
        @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
        @keyframes slideDown { from { max-height:0; opacity:0; transform: translateY(-10px);} to { max-height:1000px; opacity:1; transform: translateY(0);} }
        @keyframes slideUp { from { max-height:1000px; opacity:1; transform: translateY(0);} to { max-height:0; opacity:0; transform: translateY(-10px);} }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a1a2e 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; animation: fadeIn 0.8s ease-out; }
        h1 {
            text-align: center; font-size: clamp(2rem, 4vw, 3rem); font-weight: 700; margin: 0 0 40px 0;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .section {
            background: rgba(30, 41, 59, 0.8); border-radius: 16px; padding: 24px; margin-bottom: 24px;
            border: 1px solid var(--border); backdrop-filter: blur(10px); box-shadow: 0 4px 24px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .section:hover { border-color: var(--border-hover); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .section h2 { font-size: 1.5rem; font-weight: 600; margin: 0 0 20px 0; color: var(--text-primary); display: flex; align-items: center; gap: 12px; }
        .rates-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 16px; }
        .rate-card { background: rgba(51,65,85,0.5); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; transition: all 0.3s ease; position: relative; }
        .rate-card:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 4px 20px rgba(79,70,229,0.2); }
        .rate-card.manual { border-color: var(--warning); background: rgba(245,158,11,0.1); }
        .rate-card.manual::after { content: "Manual"; position: absolute; top: 8px; right: 8px; background: var(--warning); color: var(--bg-primary); font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 4px; }

        .converter-section { display: grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items: start; }
        .converter-input, .conversion-results { background: rgba(51,65,85,0.5); padding: 24px; border-radius: 12px; border: 1px solid var(--border); }

        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
        .form-row { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
        label { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, button {
            padding: 12px 16px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);
            border-radius: 8px; font-family: inherit; font-size: 0.875rem; transition: all 0.2s ease;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
        input::placeholder { color: var(--text-muted); }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s ease; white-space: nowrap; }
        button:hover { background: var(--primary-light); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        .btn-secondary { background: var(--bg-tertiary) !important; color: var(--text-secondary) !important; }
        .btn-secondary:hover { background: var(--border-hover) !important; color: var(--text-primary) !important; }
        .btn-danger { background: var(--danger) !important; }
        .btn-danger:hover { background: #DC2626 !important; }
        .btn-success { background: var(--success) !important; }
        .btn-success:hover { background: #059669 !important; }

        .conversion-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; margin-bottom: 8px; background: rgba(51,65,85,0.3); border-radius: 8px; transition: all 0.2s ease; }
        .conversion-item:hover { background: rgba(79,70,229,0.1); transform: translateX(4px); }
        .conversion-from { font-weight: 600; color: var(--primary-light); }
        .conversion-to { color: var(--success); font-weight: 500; }
        .update-time { text-align: center; color: var(--text-muted); font-size: 0.875rem; margin-top: 16px; }

        .status-message { padding: 12px 16px; border-radius: 8px; margin: 16px 0; text-align: center; font-weight: 500; font-size: 0.875rem; }
        .success { background: rgba(16,185,129,0.1); border: 1px solid var(--success); color: var(--success); }
        .error { background: rgba(239,68,68,0.1); border: 1px solid var(--danger); color: var(--danger); }
        .warning { background: rgba(245,158,11,0.1); border: 1px solid var(--warning); color: var(--warning); }

        .settings-panel { margin-top: 40px; background: rgba(15,23,42,0.9); border: 2px dashed var(--border); border-radius: 12px; overflow: hidden; }
        .settings-header { padding: 20px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s ease; user-select: none; }
        .settings-header:hover { background: rgba(30,41,59,0.5); }
        .settings-header h2 { font-size: 1.25rem; margin: 0; color: var(--text-secondary); }
        .collapse-icon { transition: transform 0.3s ease; font-size: 1.25rem; color: var(--text-secondary); }
        .collapse-icon.expanded { transform: rotate(180deg); }
        .settings-content { max-height: 0; overflow: hidden; transition: all 0.3s ease; opacity: 0; }
        .settings-content.expanded { max-height: 2000px; opacity: 1; padding: 20px; }

        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }
        .settings-section { background: rgba(30,41,59,0.8); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .settings-section h3 { font-size: 1rem; margin: 0 0 16px 0; color: var(--text-secondary); }

        .currency-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px; margin-top: 16px; }
        .currency-item { display: flex; justify-content: space-between; align-items: center; background: rgba(51,65,85,0.3); padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border); transition: all 0.2s ease; }
        .currency-item:hover { border-color: var(--border-hover); background: rgba(51,65,85,0.5); }
        .currency-item.default { border-color: var(--warning); background: rgba(245,158,11,0.1); }
        .currency-item .currency-info { display: flex; align-items: center; gap: 8px; }

        .result-pairs { display: grid; gap: 12px; margin-top: 16px; }
        .result-pair { display: flex; justify-content: space-between; align-items: center; background: rgba(51,65,85,0.3); padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border); }
        .result-pair:hover { border-color: var(--border-hover); background: rgba(51,65,85,0.5); }

        .loading { opacity: 0.7; pointer-events: none; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }

        .connection-status { padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.3s ease; }
        .connection-status.online { background: rgba(16,185,129,0.2); color: var(--success); border: 1px solid var(--success); }
        .connection-status.offline { background: rgba(245,158,11,0.2); color: var(--warning); border: 1px solid var(--warning); }
        .connection-status.error { background: rgba(239,68,68,0.2); color: var(--danger); border: 1px solid var(--danger); }

        .cache-info { font-size: 0.8rem; color: var(--text-muted); font-style: italic; margin-left: 8px; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 10px; }
            .section { padding: 20px 16px; margin-bottom: 20px; }
            .converter-section { grid-template-columns: 1fr; gap: 20px; }
            .rates-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
            .settings-grid { grid-template-columns: 1fr; }
            .currency-list { grid-template-columns: 1fr; }
            .form-row { gap: 8px; }
            .form-row > * { min-width: 0; flex: 1; }
            h1 { margin-bottom: 30px; }
            .settings-header, .settings-content.expanded { padding: 16px; }
        }
        @media (max-width: 480px) {
            .section { padding: 16px 12px; }
            .conversion-item { flex-direction: column; gap: 8px; text-align: center; }
            .form-row { flex-direction: column; gap: 12px; }
            .form-row > * { width: 100%; }
            .rates-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Currency Converter</h1>
        
        <!-- Exchange Rates Display -->
        <div class="section">
            <h2>
                üìä Live Rates
                <div style="display: flex; gap: 8px; margin-left: auto; align-items: center;">
                    <span id="connection-status" class="connection-status"></span>
                    <button class="btn-secondary" onclick="refreshRates()">
                        <span id="refresh-icon">üîÑ</span> Refresh
                    </button>
                </div>
            </h2>
            <div id="rates-grid" class="rates-grid"></div>
            <div id="update-time" class="update-time"></div>
        </div>
        
        <!-- Currency Converter -->
        <div class="section">
            <h2>üí± Converter</h2>
            <div class="converter-section">
                <div class="converter-input">
                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="number" id="amount" placeholder="Enter amount" step="0.01" oninput="convertCurrency()">
                    </div>
                    <div class="form-group">
                        <label for="from-currency">From</label>
                        <select id="from-currency" onchange="convertCurrency()"></select>
                    </div>
                </div>
                
                <div class="conversion-results">
                    <h3 style="margin: 0 0 16px 0; font-size: 1.125rem; color: var(--text-secondary);">Results</h3>
                    <div id="conversion-results"></div>
                </div>
            </div>
        </div>
        
        <!-- Settings Panel -->
        <div class="settings-panel">
            <div class="settings-header" onclick="toggleSettings()">
                <h2>‚öôÔ∏è Settings</h2>
                <span class="collapse-icon" id="collapse-icon">‚ñº</span>
            </div>
            
            <div class="settings-content" id="settings-content">
                <div class="settings-grid">
                    <!-- Add Currency -->
                    <div class="settings-section">
                        <h3>Add Currency</h3>
                        <div class="form-group">
                            <label for="new-currency-code">Currency Code</label>
                            <div class="form-row">
                                <input type="text" id="new-currency-code" placeholder="BRL, JPY..." maxlength="3" style="text-transform: uppercase;">
                                <button onclick="addCurrency()">Add</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manual Rate -->
                    <div class="settings-section">
                        <h3>Manual Rate</h3>
                        <div class="form-group">
                            <label for="manual-currency">Currency</label>
                            <select id="manual-currency"></select>
                            <label for="manual-rate">Rate (per USD)</label>
                            <div class="form-row">
                                <input type="number" id="manual-rate" placeholder="0.0000" step="0.0001">
                                <button onclick="setManualRate()">Set</button>
                                <button class="btn-danger" onclick="clearManualRate()">Clear</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Result Pairs Configuration -->
                    <div class="settings-section">
                        <h3>Result Display</h3>
                        <div class="form-group">
                            <label>Display Mode</label>
                            <select id="display-mode" onchange="updateDisplayMode()">
                                <option value="all">Show All Currencies</option>
                                <option value="custom">Custom Pairs Only</option>
                            </select>
                        </div>
                        <div id="custom-pairs-section" style="display: none;">
                            <div class="form-group">
                                <label>Add Custom Pair</label>
                                <div class="form-row">
                                    <select id="pair-from"></select>
                                    <select id="pair-to"></select>
                                    <button onclick="addCustomPair()">Add</button>
                                </div>
                            </div>
                            <div class="result-pairs" id="custom-pairs-list"></div>
                        </div>
                    </div>
                    
                    <!-- Default Currency -->
                    <div class="settings-section">
                        <h3>Default Currency</h3>
                        <div class="form-group">
                            <label for="default-currency">Default Currency</label>
                            <select id="default-currency" onchange="setDefaultCurrency()"></select>
                        </div>
                    </div>
                </div>
                
                <!-- Active Currencies -->
                <div class="settings-section" style="margin-top: 24px;">
                    <h3>Active Currencies</h3>
                    <div id="currency-list" class="currency-list"></div>
                </div>
                
                <div id="status-message"></div>
            </div>
        </div>
    </div>

    <script>
        // --- PERSISTENCIA M√çNIMA CON localStorage ---
        const STORAGE_KEY = 'currency_converter_state_v1';
        function storageAvailable() {
            try {
                const x = '__test__';
                localStorage.setItem(x, x);
                localStorage.removeItem(x);
                return true;
            } catch (_) {
                return false;
            }
        }
        // --------------------------------------------

        // Configuration
        let config = {
            currencies: {
                'USD': { active: true, manualRate: null, isDefault: true },
                'MXN': { active: true, manualRate: null, isDefault: false },
                'ARS': { active: true, manualRate: null, isDefault: false },
                'BRL': { active: true, manualRate: null, isDefault: false },
                'EUR': { active: true, manualRate: null, isDefault: false }
            },
            defaultCurrency: 'USD',
            displayMode: 'all', // 'all' or 'custom'
            customPairs: [],    // Array of {from: 'USD', to: 'ARS'}
            settingsExpanded: false
        };
        
        let exchangeRates = {};
        let cachedRates = {}; // Offline cache for exchange rates
        let lastUpdate = null;
        let lastCacheUpdate = null;
        let isOffline = false;

        // In-memory storage for session persistence (se mantiene, pero ahora tambi√©n persistimos en localStorage)
        let sessionData = { config: null, cachedRates: null, lastCacheUpdate: null };

        // Load configuration and cached data (MODIFICADO para leer localStorage primero)
        function loadConfig() {
            // 1) Intenta restaurar desde localStorage
            if (storageAvailable()) {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) {
                    try {
                        const saved = JSON.parse(raw);
                        if (saved.config) {
                            // Merge conservador para no perder defaults nuevos entre versiones
                            config = { ...config, ...saved.config };
                            // Asegura estructura de currencies (merge por moneda)
                            if (saved.config.currencies) {
                                config.currencies = { ...config.currencies, ...saved.config.currencies };
                            }
                        }
                        if (saved.cachedRates) {
                            cachedRates = { ...saved.cachedRates };
                        }
                        if (saved.lastCacheUpdate) {
                            lastCacheUpdate = new Date(saved.lastCacheUpdate);
                        }
                    } catch (_) { /* ignora corrupci√≥n */ }
                }
            }

            // 2) Fallback de la sesi√≥n en memoria (opcional)
            if (sessionData.config) {
                config = { ...config, ...sessionData.config };
            }
            if (sessionData.cachedRates) {
                cachedRates = sessionData.cachedRates;
                lastCacheUpdate = sessionData.lastCacheUpdate;
            }
            
            // 3) Si hay cache, precarga para UI
            if (Object.keys(cachedRates).length > 0) {
                exchangeRates = { ...cachedRates };
                lastUpdate = lastCacheUpdate;
            }
        }

        // Save configuration and cache data (MODIFICADO para escribir a localStorage)
        function saveConfig() {
            // Mantener copia en memoria
            sessionData.config = { ...config };
            sessionData.cachedRates = { ...cachedRates };
            sessionData.lastCacheUpdate = lastCacheUpdate;

            // Persistir en localStorage
            if (storageAvailable()) {
                const payload = {
                    config,
                    cachedRates,
                    lastCacheUpdate: lastCacheUpdate ? lastCacheUpdate.toISOString() : null
                };
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                } catch (_) {
                    // Si se llena la quota o est√° bloqueado, simplemente no rompemos nada
                }
            }
        }

        // Cache exchange rates for offline use (sin cambios l√≥gicos, pero ahora s√≠ persiste)
        function cacheExchangeRates() {
            cachedRates = { ...exchangeRates };
            lastCacheUpdate = new Date();
            saveConfig();
        }

        // Toggle settings panel
        function toggleSettings() {
            const content = document.getElementById('settings-content');
            const icon = document.getElementById('collapse-icon');
            
            config.settingsExpanded = !config.settingsExpanded;
            
            if (config.settingsExpanded) {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            } else {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            }
            
            saveConfig();
        }

        // Initialize
        function init() {
            loadConfig();
            updateAllSelects();
            updateCurrencyList();
            updateDisplayModeUI();
            
            // Set settings panel state
            if (config.settingsExpanded) {
                // Si ya estaba expandido, forzamos estado visual correcto
                const content = document.getElementById('settings-content');
                const icon = document.getElementById('collapse-icon');
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
            
            // Si hay cache, mostrar primero; luego intentar actualizar
            if (Object.keys(cachedRates).length > 0) {
                loadCachedRates();
                updateConnectionStatus('offline');
                setTimeout(() => { fetchExchangeRates(); }, 1000);
            } else {
                fetchExchangeRates();
            }
            
            document.getElementById('amount').value = '100';

            // Asegurar que el select "from-currency" arranque en el default persistido
            document.getElementById('from-currency').value = config.defaultCurrency || 'USD';

            convertCurrency();
            
            // Listeners online/offline
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
        }

        // Handle online event
        function handleOnline() {
            showStatus('Connection restored - updating rates', 'success');
            fetchExchangeRates();
        }

        // Handle offline event  
        function handleOffline() {
            isOffline = true;
            updateConnectionStatus('offline');
            if (Object.keys(cachedRates).length > 0) {
                showStatus('Offline mode - using cached rates', 'warning');
            } else {
                showStatus('Offline - no cached data available', 'error');
            }
        }

        // (Hay dos definiciones en tu c√≥digo original; dejamos esta sencilla que siempre refresca)
        function refreshRates() {
            const icon = document.getElementById('refresh-icon');
            icon.style.animation = 'spin 1s linear';
            setTimeout(() => icon.style.animation = '', 1000);
            fetchExchangeRates();
        }

        // Fetch exchange rates
        async function fetchExchangeRates() {
            try {
                showStatus('Updating rates...', 'warning');
                updateConnectionStatus('loading');
                
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
                const data = await response.json();

                // --- ARS desde dolarapi.com ---
                let arsRate = null;
                try {
                    const arsRes = await fetch('https://dolarapi.com/v1/dolares/oficial');
                    if (arsRes.ok) {
                        const arsData = await arsRes.json();
                        arsRate = arsData.venta; // 1 USD en ARS
                    }
                } catch (_) {
                    // Ignorar error; fallback abajo
                }
                
                isOffline = false;
                
                Object.keys(config.currencies).forEach(currency => {
                    if (config.currencies[currency].active) {
                        if (config.currencies[currency].manualRate !== null) {
                            exchangeRates[currency] = config.currencies[currency].manualRate;
                        } else if (currency === 'USD') {
                            exchangeRates[currency] = 1;
                        } else {
                            if (currency === 'ARS') {
                                // Preferir ARS desde dolarapi
                                if (config.currencies[currency].manualRate !== null) {
                                    exchangeRates[currency] = config.currencies[currency].manualRate;
                                } else if (arsRate !== null) {
                                    exchangeRates[currency] = arsRate;
                                } else {
                                    exchangeRates[currency] = data.rates['ARS'] || 0; // fallback
                                }
                            } else {
                                exchangeRates[currency] = data.rates[currency] || 0;
                            }
                        }
                    }
                });
                
                lastUpdate = new Date();
                cacheExchangeRates(); // ahora persiste cache + settings
                
                updateRatesDisplay();
                convertCurrency();
                updateConnectionStatus('online');
                showStatus('Rates updated successfully', 'success');
                
            } catch (error) {
                console.error('Error fetching rates:', error);
                isOffline = true;
                
                // Try to use cached rates
                if (Object.keys(cachedRates).length > 0) {
                    loadCachedRates();
                    updateConnectionStatus('offline');
                    showStatus('Using cached rates (offline mode)', 'warning');
                } else {
                    updateConnectionStatus('error');
                    showStatus('Failed to update rates and no cache available', 'error');
                }
            }
        }

        // Load cached rates when offline
        function loadCachedRates() {
            Object.keys(config.currencies).forEach(currency => {
                if (config.currencies[currency].active) {
                    if (config.currencies[currency].manualRate !== null) {
                        exchangeRates[currency] = config.currencies[currency].manualRate;
                    } else if (cachedRates[currency]) {
                        exchangeRates[currency] = cachedRates[currency];
                    } else if (currency === 'USD') {
                        exchangeRates[currency] = 1;
                    }
                }
            });
            lastUpdate = lastCacheUpdate;
            updateRatesDisplay();
            convertCurrency();
        }

        // Update connection status indicator
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connection-status');
            switch(status) {
                case 'online':  statusEl.textContent = 'Online';  statusEl.className = 'connection-status online'; break;
                case 'offline': statusEl.textContent = 'Offline'; statusEl.className = 'connection-status offline'; break;
                case 'error':   statusEl.textContent = 'Error';   statusEl.className = 'connection-status error'; break;
                case 'loading': statusEl.textContent = 'Loading'; statusEl.className = 'connection-status'; break;
                default:        statusEl.textContent = '';        statusEl.className = 'connection-status';
            }
        }

        // Update rates display
        function updateRatesDisplay() {
            const grid = document.getElementById('rates-grid');
            const activeCurrencies = Object.keys(config.currencies).filter(c => config.currencies[c].active);
            grid.innerHTML = '';
            activeCurrencies.forEach(currency => {
                if (currency !== 'USD' && exchangeRates[currency]) {
                    const card = document.createElement('div');
                    card.className = `rate-card ${config.currencies[currency].manualRate !== null ? 'manual' : ''}`;
                    card.innerHTML = `<strong>1 USD = ${formatCurrency(exchangeRates[currency], currency)}</strong>`;
                    grid.appendChild(card);
                }
            });

            const updateTimeEl = document.getElementById('update-time');
            if (lastUpdate) {
                let timeText = `Updated: ${lastUpdate.toLocaleString()}`;
                if (isOffline && lastCacheUpdate) {
                    const cacheAge = Math.floor((new Date() - lastCacheUpdate) / (1000 * 60));
                    timeText += ` <span class="cache-info">(Cached ${cacheAge} min ago)</span>`;
                }
                updateTimeEl.innerHTML = timeText;
            }
        }

        // Format currency
        function formatCurrency(value, currency) {
            try {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: currency,
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 4
                }).format(value);
            } catch (e) {
                return `${currency} ${parseFloat(value).toFixed(4)}`;
            }
        }

        // Add currency
        function addCurrency() {
            const code = document.getElementById('new-currency-code').value.toUpperCase().trim();
            if (!code || code.length !== 3) { showStatus('Enter valid 3-letter currency code', 'error'); return; }
            if (config.currencies[code] && config.currencies[code].active) { showStatus('Currency already exists', 'warning'); return; }
            config.currencies[code] = { active: true, manualRate: null, isDefault: false };
            saveConfig();
            updateAllSelects();
            updateCurrencyList();
            fetchExchangeRates();
            showStatus(`${code} added successfully`, 'success');
            document.getElementById('new-currency-code').value = '';
        }

        // Remove currency
        function removeCurrency(currency) {
            if (currency === 'USD') { showStatus('Cannot remove USD', 'error'); return; }
            if (currency === config.defaultCurrency) { showStatus('Cannot remove default currency', 'error'); return; }
            config.currencies[currency].active = false;
            // Remove from custom pairs
            config.customPairs = config.customPairs.filter(pair => pair.from !== currency && pair.to !== currency);
            saveConfig();
            updateAllSelects();
            updateCurrencyList();
            updateCustomPairsList();
            updateRatesDisplay();
            convertCurrency();
            showStatus(`${currency} removed`, 'success');
        }

        // Set manual rate
        function setManualRate() {
            const currency = document.getElementById('manual-currency').value;
            const rate = parseFloat(document.getElementById('manual-rate').value);
            if (!currency || isNaN(rate) || rate <= 0) { showStatus('Select currency and enter valid rate', 'error'); return; }
            config.currencies[currency].manualRate = rate;
            exchangeRates[currency] = rate;
            cachedRates[currency] = rate; // tambi√©n persiste en cache
            saveConfig();
            updateRatesDisplay();
            convertCurrency();
            updateCurrencyList();
            showStatus(`Manual rate set for ${currency}`, 'success');
            document.getElementById('manual-rate').value = '';
        }

        // Clear manual rate
        function clearManualRate() {
            const currency = document.getElementById('manual-currency').value;
            if (!currency) { showStatus('Select a currency', 'error'); return; }
            config.currencies[currency].manualRate = null;
            // Restaurar desde cache o refetchear
            if (cachedRates[currency] && !isOffline) {
                fetchExchangeRates();
            } else if (cachedRates[currency]) {
                exchangeRates[currency] = cachedRates[currency];
                updateRatesDisplay();
                convertCurrency();
            }
            saveConfig();
            updateCurrencyList();
            showStatus(`Manual rate cleared for ${currency}`, 'success');
        }

        // Set default currency
        function setDefaultCurrency() {
            const newDefault = document.getElementById('default-currency').value;
            if (config.defaultCurrency && config.currencies[config.defaultCurrency]) {
                config.currencies[config.defaultCurrency].isDefault = false;
            }
            config.defaultCurrency = newDefault;
            config.currencies[newDefault].isDefault = true;
            saveConfig();
            updateCurrencyList();
            document.getElementById('from-currency').value = newDefault;
            convertCurrency();
            showStatus(`Default changed to ${newDefault}`, 'success');
        }

        // Update display mode
        function updateDisplayMode() {
            const mode = document.getElementById('display-mode').value;
            config.displayMode = mode;
            const customSection = document.getElementById('custom-pairs-section');
            if (mode === 'custom') {
                customSection.style.display = 'block';
                updateCustomPairsList();
            } else {
                customSection.style.display = 'none';
            }
            saveConfig();
            convertCurrency();
            showStatus(`Display mode changed to ${mode === 'all' ? 'All Currencies' : 'Custom Pairs'}`, 'success');
        }

        // Add custom pair
        function addCustomPair() {
            const from = document.getElementById('pair-from').value;
            const to = document.getElementById('pair-to').value;
            if (!from || !to) { showStatus('Select both currencies', 'error'); return; }
            if (from === to) { showStatus('Cannot create pair with same currency', 'error'); return; }
            const exists = config.customPairs.some(pair => pair.from === from && pair.to === to);
            if (exists) { showStatus('Pair already exists', 'warning'); return; }
            config.customPairs.push({ from, to });
            saveConfig();
            updateCustomPairsList();
            convertCurrency();
            showStatus(`Added pair ${from} ‚Üí ${to}`, 'success');
        }

        // Remove custom pair
        function removeCustomPair(from, to) {
            config.customPairs = config.customPairs.filter(pair => !(pair.from === from && pair.to === to));
            saveConfig();
            updateCustomPairsList();
            convertCurrency();
            showStatus(`Removed pair ${from} ‚Üí ${to}`, 'success');
        }

        // Update custom pairs list
        function updateCustomPairsList() {
            const list = document.getElementById('custom-pairs-list');
            list.innerHTML = '';
            if (config.customPairs.length === 0) {
                list.innerHTML = '<p style="color: var(--text-muted); text-align: center; margin: 16px 0;">No custom pairs configured</p>';
                return;
            }
            config.customPairs.forEach(pair => {
                const item = document.createElement('div');
                item.className = 'result-pair';
                item.innerHTML = `
                    <span><strong>${pair.from}</strong> ‚Üí <strong>${pair.to}</strong></span>
                    <button class="btn-danger" onclick="removeCustomPair('${pair.from}', '${pair.to}')" style="font-size: 0.75rem; padding: 4px 8px;">Remove</button>
                `;
                list.appendChild(item);
            });
        }

        // Update display mode UI
        function updateDisplayModeUI() {
            document.getElementById('display-mode').value = config.displayMode;
            // No llamamos save ac√° para evitar escribir sin cambios; convertCurrency se llamar√° en init
        }

        // Update all selects
        function updateAllSelects() {
            updateCurrencySelects();
            updateManualCurrencySelect();
            updatePairSelects();
        }

        // Update currency selects
        function updateCurrencySelects() {
            const activeCurrencies = Object.keys(config.currencies).filter(c => config.currencies[c].active).sort();
            const selects = ['from-currency', 'default-currency'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '';
                activeCurrencies.forEach(currency => {
                    const option = document.createElement('option');
                    option.value = currency;
                    option.textContent = currency;
                    select.appendChild(option);
                });
                if (activeCurrencies.includes(currentValue)) {
                    select.value = currentValue;
                } else {
                    select.value = config.defaultCurrency;
                }
            });
        }

        // Update manual currency select
        function updateManualCurrencySelect() {
            const select = document.getElementById('manual-currency');
            const activeCurrencies = Object.keys(config.currencies).filter(c => config.currencies[c].active && c !== 'USD').sort();
            select.innerHTML = '<option value="">Select currency</option>';
            activeCurrencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = currency;
                select.appendChild(option);
            });
        }

        // Update pair selects
        function updatePairSelects() {
            const activeCurrencies = Object.keys(config.currencies).filter(c => config.currencies[c].active).sort();
            const selects = ['pair-from', 'pair-to'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select currency</option>';
                activeCurrencies.forEach(currency => {
                    const option = document.createElement('option');
                    option.value = currency;
                    option.textContent = currency;
                    select.appendChild(option);
                });
            });
        }

        // Update currency list
        function updateCurrencyList() {
            const list = document.getElementById('currency-list');
            const activeCurrencies = Object.keys(config.currencies).filter(c => config.currencies[c].active).sort();
            list.innerHTML = '';
            activeCurrencies.forEach(currency => {
                const item = document.createElement('div');
                item.className = `currency-item ${config.currencies[currency].isDefault ? 'default' : ''}`;
                const info = document.createElement('div');
                info.className = 'currency-info';
                const isManual = config.currencies[currency].manualRate !== null;
                const rate = exchangeRates[currency] ? ` (${exchangeRates[currency].toFixed(4)})` : '';
                info.innerHTML = `
                    <strong>${currency}</strong>${rate}
                    ${isManual ? '<span style="color: var(--warning); font-size: 0.75rem;">MANUAL</span>' : ''}
                    ${config.currencies[currency].isDefault ? '<span style="color: var(--warning); font-size: 0.75rem;">DEFAULT</span>' : ''}
                `;
                const actions = document.createElement('div');
                if (currency !== 'USD') {
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Remove';
                    removeBtn.className = 'btn-danger';
                    removeBtn.style.fontSize = '0.75rem';
                    removeBtn.style.padding = '6px 12px';
                    removeBtn.onclick = () => removeCurrency(currency);
                    actions.appendChild(removeBtn);
                }
                item.appendChild(info);
                item.appendChild(actions);
                list.appendChild(item);
            });
        }

        // Convert currency
        function convertCurrency() {
            const amount = parseFloat(document.getElementById('amount').value);
            const fromCurrency = document.getElementById('from-currency').value;
            const resultsDiv = document.getElementById('conversion-results');
            if (isNaN(amount) || amount <= 0 || !fromCurrency) {
                resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Enter amount to see conversions</p>';
                return;
            }
            resultsDiv.innerHTML = '';
            if (config.displayMode === 'all') {
                const activeCurrencies = Object.keys(config.currencies).filter(c => config.currencies[c].active && c !== fromCurrency).sort();
                activeCurrencies.forEach(toCurrency => {
                    addConversionResult(amount, fromCurrency, toCurrency, resultsDiv);
                });
            } else if (config.displayMode === 'custom') {
                if (config.customPairs.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No custom pairs configured</p>';
                    return;
                }
                config.customPairs.forEach(pair => {
                    let convertedAmount;
                    let amountInPairFrom;
                    if (fromCurrency === pair.from) {
                        amountInPairFrom = amount;
                    } else {
                        if (fromCurrency === 'USD') {
                            amountInPairFrom = amount / exchangeRates[pair.from];
                        } else if (pair.from === 'USD') {
                            amountInPairFrom = amount / exchangeRates[fromCurrency];
                        } else {
                            const usdAmount = amount / exchangeRates[fromCurrency];
                            amountInPairFrom = usdAmount / exchangeRates[pair.from];
                        }
                    }
                    if (pair.from === 'USD') {
                        convertedAmount = amountInPairFrom * exchangeRates[pair.to];
                    } else if (pair.to === 'USD') {
                        convertedAmount = amountInPairFrom / exchangeRates[pair.from];
                    } else {
                        const usdAmount = amountInPairFrom / exchangeRates[pair.from];
                        convertedAmount = usdAmount * exchangeRates[pair.to];
                    }
                    const item = document.createElement('div');
                    item.className = 'conversion-item';
                    item.innerHTML = `
                        <span class="conversion-from">${formatCurrency(amountInPairFrom, pair.from)}</span>
                        <span class="conversion-to">${formatCurrency(convertedAmount, pair.to)}</span>
                    `;
                    resultsDiv.appendChild(item);
                });
            }
            if (resultsDiv.innerHTML === '') {
                resultsDiv.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No conversion rates available</p>';
            }
        }

        // Helper function to add conversion result
        function addConversionResult(amount, fromCurrency, toCurrency, container) {
            const rate = exchangeRates[toCurrency] && exchangeRates[fromCurrency];
            if (rate) {
                let convertedAmount;
                if (fromCurrency === 'USD') {
                    convertedAmount = amount * exchangeRates[toCurrency];
                } else if (toCurrency === 'USD') {
                    convertedAmount = amount / exchangeRates[fromCurrency];
                } else {
                    const usdAmount = amount / exchangeRates[fromCurrency];
                    convertedAmount = usdAmount * exchangeRates[toCurrency];
                }
                const item = document.createElement('div');
                item.className = 'conversion-item';
                item.innerHTML = `
                    <span class="conversion-from">${formatCurrency(amount, fromCurrency)}</span>
                    <span class="conversion-to">${formatCurrency(convertedAmount, toCurrency)}</span>
                `;
                container.appendChild(item);
            }
        }

        // Show status
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = 'status-message';
            }, 4000);
        }

        // Auto-refresh every 5 minutes (only if online)
        setInterval(() => {
            if (navigator.onLine && !isOffline) {
                fetchExchangeRates();
            }
        }, 300000);

        // Initialize
        window.onload = init;
    </script>
</body>
</html>
