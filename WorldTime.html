<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>World Time Sync</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#0f172a;
  --panel:#111827;
  --card:#1f2937;
  --accent:#22c55e;
}

body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:#fff;
}

/* HEADER */

header{
  background:var(--panel);
  padding:12px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}

input,button{
  padding:8px 10px;
  border-radius:10px;
  border:none;
  font-size:14px;
}

button{ cursor:pointer }

/* STATUS */

#status{
  font-weight:bold;
  padding:6px 10px;
  border-radius:999px;
}

.online{ background:#166534 }
.offline{ background:#7f1d1d }

/* SEARCH */

.searchBox{ position:relative }

#results{
  position:absolute;
  top:40px;
  left:0;
  width:320px;
  max-height:240px;
  overflow:auto;
  background:var attaching
  var(--panel);
  border-radius:12px;
  box-shadow:0 10px 30px #0008;
  z-index:20;
}

.result{
  padding:10px;
  cursor:pointer;
}

.result:hover{ background:#1f2937 }

/* CITIES */

#cities{ padding:14px }

.city{
  background:var(--card);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:.2s;
}

.city:hover{ transform:translateY(-2px) }

.city.base{ outline:2px solid var(--accent) }

/* PERIOD COLORS */

.night{ background:#1e293b }
.morning{ background:#0369a1 }
.afternoon{ background:#b45309 }
.evening{ background:#6d28d9 }
</style>
</head>

<body>

<header>

<div id="status">Checking...</div>

<div class="searchBox">
  <input id="search" placeholder="Buscar ciudad">
  <div id="results"></div>
</div>

<input type="time" id="timeInput">

<label>
<input type="checkbox" id="nowToggle" checked>
Hora actual
</label>

</header>

<div id="cities"></div>

<script>
const KEY="wts_pro_v2";

let state={
cities:[],
base:0,
custom:"12:00",
useNow:true
};

/* ========= STORAGE ========= */

function save(){localStorage.setItem(KEY,JSON.stringify(state))}
function load(){const s=localStorage.getItem(KEY);if(s)state=JSON.parse(s)}

/* ========= CONNECTION ========= */

const statusEl=document.getElementById("status");

function updateConnection(){
  const online=navigator.onLine;
  statusEl.textContent=online?"ONLINE":"OFFLINE";
  statusEl.className=online?"online":"offline";
}

window.addEventListener("online",updateConnection);
window.addEventListener("offline",updateConnection);
updateConnection();

/* ========= TIME ========= */

function period(h){
if(h<6)return"night"
if(h<12)return"morning"
if(h<18)return"afternoon"
if(h<22)return"evening"
return"night"
}

function baseDate(){
if(state.useNow)return new Date()
const d=new Date()
const[t,m]=state.custom.split(":")
d.setHours(t,m,0,0)
return d
}

function timeInTZ(date,tz){
return new Intl.DateTimeFormat("es-AR",{
hour:"2-digit",minute:"2-digit",
hour12:false,timeZone:tz
}).format(date)
}

/* ========= RENDER ========= */

function render(){
const c=document.getElementById("cities")
c.innerHTML=""
const base=baseDate()

state.cities.forEach((city,i)=>{
const t=timeInTZ(base,city.tz)
const h=parseInt(t.split(":")[0])

const d=document.createElement("div")
d.className="city "+period(h)+(i===state.base?" base":"")
d.draggable=true

d.innerHTML=`
<div><b>${city.name}</b><br>${t}</div>
<div>
<button onclick="setBase(${i})">⭐</button>
<button onclick="removeCity(${i})">❌</button>
</div>`

d.ondragstart=e=>e.dataTransfer.setData("i",i)
d.ondragover=e=>e.preventDefault()
d.ondrop=e=>{
const from=e.dataTransfer.getData("i")
const item=state.cities.splice(from,1)[0]
state.cities.splice(i,0,item)
save();render()
}

c.appendChild(d)
})
}

/* ========= ACTIONS ========= */

function setBase(i){state.base=i;save();render()}

function removeCity(i){
state.cities.splice(i,1)
if(state.base>=state.cities.length)state.base=0
save();render()
}

function addCity(name,tz){
if(!state.cities.some(c=>c.tz===tz)){
state.cities.push({name,tz})
save();render()
}
}

/* ========= SEARCH ========= */

const results=document.getElementById("results");

let debounce;

document.getElementById("search").oninput=e=>{
clearTimeout(debounce);

debounce=setTimeout(()=>search(e.target.value),300);
};

async function search(q){
if(!navigator.onLine||q.length<2){
results.innerHTML="";
return;
}

const r=await fetch(
`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`
);
const data=await r.json();

results.innerHTML="";

for(const item of data){

const d=document.createElement("div");
d.className="result";
d.textContent=item.display_name;

d.onclick=async()=>{
try{
const tzr=await fetch(
`https://timeapi.io/api/TimeZone/coordinate?latitude=${item.lat}&longitude=${item.lon}`
);
const tzdata=await tzr.json();

addCity(item.display_name,tzdata.timeZone);
results.innerHTML="";
}catch{}
};

results.appendChild(d);
}
}

/* ========= CONTROLS ========= */

document.getElementById("nowToggle").onchange=e=>{
state.useNow=e.target.checked;
save();render();
}

document.getElementById("timeInput").oninput=e=>{
state.custom=e.target.value;
state.useNow=false;
save();render();
}

/* ========= INIT ========= */

load();
render();
setInterval(render,1000);
</script>

</body>
</html>
